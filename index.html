<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>PEDALADA DOS ESTADOS</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- PeerJS para compartilhamento P2P -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- PWA / Manifest inline -->
    <meta name="theme-color" content="#0d1b2a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #0d1b2a;
            --bg-card: #1b2838;
            --accent: #00e676;
            --accent-glow: rgba(0, 230, 118, 0.3);
            --danger: #ff5252;
            --warning: #ffab40;
            --text: #e0e0e0;
            --text-muted: #78909c;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ========= TELA INICIAL ========= */
        #splash-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #0d1b2a 0%, #1a3a4a 50%, #0d1b2a 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.6s ease;
        }

        #splash-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .splash-icon {
            margin-bottom: 20px;
            animation: pulse-bike 2s ease-in-out infinite;
        }

        .splash-icon img {
            width: 160px;
            height: auto;
            border-radius: 20px;
            box-shadow: 0 0 40px rgba(0, 130, 255, 0.3);
        }

        @keyframes pulse-bike {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .splash-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 28px;
            font-weight: 900;
            color: var(--accent);
            text-align: center;
            text-shadow: 0 0 30px var(--accent-glow);
            letter-spacing: 3px;
            margin-bottom: 8px;
        }

        .splash-subtitle {
            font-size: 14px;
            color: var(--text-muted);
            letter-spacing: 5px;
            text-transform: uppercase;
            margin-bottom: 40px;
        }

        .splash-btn {
            background: linear-gradient(135deg, var(--accent), #00c853);
            color: #0d1b2a;
            border: none;
            padding: 16px 48px;
            border-radius: 50px;
            font-family: 'Orbitron', sans-serif;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            letter-spacing: 2px;
            box-shadow: 0 0 30px var(--accent-glow);
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .splash-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 50px var(--accent-glow);
        }

        .splash-btn:active {
            transform: scale(0.97);
        }

        /* ========= HEADER ========= */
        #app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: rgba(13, 27, 42, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            z-index: 1000;
            border-bottom: 1px solid rgba(0,230,118,0.15);
        }

        .header-logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 11px;
            font-weight: 700;
            color: var(--accent);
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .header-apoio {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: auto;
        }

        .header-apoio span {
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .header-apoio img {
            height: 30px;
            border-radius: 4px;
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .status-dot.active {
            background: var(--accent);
            box-shadow: 0 0 8px var(--accent-glow);
            animation: blink 1.5s ease-in-out infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* ========= MAPA ========= */
        #map-container {
            position: fixed;
            top: 56px;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* ========= PAINEL DE CONTROLE ========= */
        #control-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 500;
            padding: 0 12px 20px;
            pointer-events: none;
        }

        #control-panel > * {
            pointer-events: auto;
        }

        /* Stats Bar */
        .stats-bar {
            display: none;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .stats-bar.visible {
            display: grid;
        }

        .stat-card {
            background: rgba(27, 40, 56, 0.92);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 10px 8px;
            text-align: center;
            border: 1px solid rgba(0,230,118,0.1);
        }

        .stat-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-label {
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 2px;
        }

        /* Bot√µes de a√ß√£o */
        .action-row {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
        }

        .btn-pedal {
            flex: 1;
            max-width: 280px;
            padding: 18px 24px;
            border-radius: 60px;
            border: none;
            font-family: 'Orbitron', sans-serif;
            font-size: 15px;
            font-weight: 700;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .btn-pedal.start {
            background: linear-gradient(135deg, var(--accent), #00c853);
            color: #0d1b2a;
            box-shadow: 0 4px 25px var(--accent-glow);
        }

        .btn-pedal.stop {
            background: linear-gradient(135deg, var(--danger), #d32f2f);
            color: white;
            box-shadow: 0 4px 25px rgba(255,82,82,0.3);
        }

        .btn-pedal:active {
            transform: scale(0.96);
        }

        .btn-circle {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            background: rgba(27, 40, 56, 0.92);
            backdrop-filter: blur(10px);
            color: var(--text);
            font-size: 22px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }

        .btn-circle:active {
            transform: scale(0.9);
            background: rgba(0,230,118,0.2);
        }

        /* ========= MODAL COMPARTILHAR ========= */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: none;
            align-items: flex-end;
            justify-content: center;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal-sheet {
            background: var(--bg-card);
            border-radius: 24px 24px 0 0;
            padding: 24px 20px 36px;
            width: 100%;
            max-width: 480px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-handle {
            width: 40px;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            margin: 0 auto 20px;
        }

        .modal-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 6px;
        }

        .modal-desc {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 20px;
        }

        .share-code-box {
            background: rgba(0,230,118,0.08);
            border: 2px dashed rgba(0,230,118,0.3);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .share-code {
            font-family: 'Orbitron', sans-serif;
            font-size: 32px;
            font-weight: 900;
            color: var(--accent);
            letter-spacing: 6px;
            word-break: break-all;
        }

        .share-code-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .share-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .share-btn {
            flex: 1;
            padding: 14px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .share-btn.copy {
            background: var(--accent);
            color: #0d1b2a;
        }

        .share-btn.native {
            background: rgba(255,255,255,0.1);
            color: var(--text);
        }

        .divider {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 20px 0;
            color: var(--text-muted);
            font-size: 12px;
        }

        .divider::before, .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(255,255,255,0.1);
        }

        .join-section input {
            width: 100%;
            padding: 14px 16px;
            border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.3);
            color: var(--text);
            font-family: 'Orbitron', sans-serif;
            font-size: 18px;
            text-align: center;
            letter-spacing: 4px;
            outline: none;
            transition: border-color 0.3s;
        }

        .join-section input:focus {
            border-color: var(--accent);
        }

        .join-section input::placeholder {
            color: var(--text-muted);
            font-size: 13px;
            letter-spacing: 1px;
            font-family: 'Inter', sans-serif;
        }

        .join-btn {
            width: 100%;
            margin-top: 12px;
            padding: 14px;
            border-radius: 12px;
            border: 2px solid var(--accent);
            background: transparent;
            color: var(--accent);
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            letter-spacing: 1px;
            transition: all 0.3s;
        }

        .join-btn:hover {
            background: rgba(0,230,118,0.1);
        }

        .modal-close {
            width: 100%;
            margin-top: 16px;
            padding: 14px;
            border-radius: 12px;
            border: none;
            background: rgba(255,255,255,0.05);
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        /* ========= LISTA DE CICLISTAS CONECTADOS ========= */
        .riders-panel {
            position: fixed;
            top: 64px;
            right: 12px;
            z-index: 500;
            display: none;
        }

        .riders-panel.visible {
            display: block;
        }

        .riders-card {
            background: rgba(27, 40, 56, 0.92);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid rgba(0,230,118,0.1);
            min-width: 180px;
        }

        .riders-title {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .rider-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-size: 13px;
        }

        .rider-color {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        /* ========= TOAST NOTIFICATIONS ========= */
        .toast {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: rgba(27, 40, 56, 0.95);
            backdrop-filter: blur(10px);
            color: var(--text);
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            z-index: 3000;
            opacity: 0;
            transition: all 0.3s ease;
            border: 1px solid rgba(0,230,118,0.2);
            pointer-events: none;
            text-align: center;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* ========= LOADING OVERLAY ========= */
        .loading {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 5000;
        }

        .loading.visible {
            display: flex;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(0,230,118,0.2);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ========= RESPONSIVE ========= */
        @media (min-width: 600px) {
            .stat-card { padding: 14px 12px; }
            .stat-value { font-size: 22px; }
            .splash-title { font-size: 36px; }
        }

        /* Leaflet custom marker */
        .cyclist-marker {
            background: none;
            border: none;
        }

        .marker-dot {
            width: 20px;
            height: 20px;
            background: var(--accent);
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 15px var(--accent-glow);
            position: relative;
        }

        .marker-dot.other {
            background: #42a5f5;
            box-shadow: 0 0 15px rgba(66,165,245,0.4);
        }

        .marker-dot::after {
            content: '';
            position: absolute;
            inset: -6px;
            border-radius: 50%;
            border: 2px solid;
            border-color: inherit;
            opacity: 0.4;
            animation: ping 2s ease-out infinite;
        }

        @keyframes ping {
            0% { transform: scale(1); opacity: 0.4; }
            100% { transform: scale(2); opacity: 0; }
        }
    </style>
</head>
<body>

    <!-- ========= TELA INICIAL ========= -->
    <div id="splash-screen">
        <div class="splash-icon"><img src="logo.png" alt="Pedalada dos Estados"></div>
        <div class="splash-title">PEDALADA<br>DOS ESTADOS</div>
        <div class="splash-subtitle">Conecte-se &bull; Pedale &bull; Compartilhe</div>
        <button class="splash-btn" onclick="enterApp()">ENTRAR</button>
    </div>

    <!-- ========= HEADER ========= -->
    <header id="app-header" style="display:none;">
        <div class="header-logo"><img src="logo.png" alt="Logo" style="height:32px;border-radius:6px;">PEDALADA DOS ESTADOS</div>
        <div class="header-apoio">
            <span>Apoio</span>
            <img src="apoio.png" alt="CONSEG e Lions Club">
        </div>
        <div class="header-status">
            <span id="status-text">Aguardando</span>
            <div class="status-dot" id="status-dot"></div>
        </div>
    </header>

    <!-- ========= MAPA ========= -->
    <div id="map-container" style="display:none;">
        <div id="map"></div>
    </div>

    <!-- ========= PAINEL DE CICLISTAS ========= -->
    <div class="riders-panel" id="riders-panel">
        <div class="riders-card">
            <div class="riders-title">üö¥ Ciclistas Conectados</div>
            <div id="riders-list"></div>
        </div>
    </div>

    <!-- ========= CONTROLES ========= -->
    <div id="control-panel" style="display:none;">
        <div class="stats-bar" id="stats-bar">
            <div class="stat-card">
                <div class="stat-value" id="stat-speed">0.0</div>
                <div class="stat-label">km/h</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-distance">0.00</div>
                <div class="stat-label">km</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-time">00:00</div>
                <div class="stat-label">Tempo</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-avg">0.0</div>
                <div class="stat-label">M√©dia</div>
            </div>
        </div>

        <div class="action-row">
            <button class="btn-circle" onclick="centerMap()" title="Centralizar">üìç</button>
            <button class="btn-pedal start" id="btn-pedal" onclick="togglePedal()">
                MODO PEDAL
            </button>
            <button class="btn-circle" onclick="openShareModal()" title="Compartilhar">üì°</button>
        </div>
    </div>

    <!-- ========= MODAL COMPARTILHAR ========= -->
    <div class="modal-overlay" id="share-modal">
        <div class="modal-sheet">
            <div class="modal-handle"></div>
            <div class="modal-title">Compartilhar Rota</div>
            <div class="modal-desc">Compartilhe seu c√≥digo com outros ciclistas para que vejam sua rota em tempo real.</div>

            <div class="share-code-box">
                <div class="share-code" id="my-code">------</div>
                <div class="share-code-label">Seu c√≥digo de rota</div>
            </div>

            <div class="share-actions">
                <button class="share-btn copy" onclick="copyCode()">üìã Copiar C√≥digo</button>
                <button class="share-btn native" onclick="nativeShare()">üì§ Compartilhar</button>
            </div>

            <div class="divider">ou acompanhe um ciclista</div>

            <div class="join-section">
                <input type="text" id="join-code-input" placeholder="Digite o c√≥digo do ciclista"
                       maxlength="8" autocomplete="off" spellcheck="false">
                <button class="join-btn" onclick="joinRider()">üîó CONECTAR</button>
            </div>

            <button class="modal-close" onclick="closeShareModal()">Fechar</button>
        </div>
    </div>

    <!-- ========= TOAST ========= -->
    <div class="toast" id="toast"></div>

    <!-- ========= LOADING ========= -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <script>
        // ============================================================
        //  PEDALADA DOS ESTADOS - App Principal
        // ============================================================

        // --- Estado Global ---
        const state = {
            isPedaling: false,
            watchId: null,
            wakeLock: null,
            startTime: null,
            totalDistance: 0,
            positions: [],
            currentPos: null,
            timerInterval: null,
            peer: null,
            peerId: null,
            connections: [],       // conex√µes ativas
            connectedRiders: {},   // { peerId: { name, positions, marker, polyline, color } }
            broadcastInterval: null,
        };

        const RIDER_COLORS = ['#42a5f5', '#ff7043', '#ab47bc', '#ffca28', '#26c6da', '#ec407a'];
        let colorIndex = 0;

        let map, myMarker, myPolyline;

        // --- Entrar no App ---
        function enterApp() {
            document.getElementById('splash-screen').classList.add('hidden');
            setTimeout(() => {
                document.getElementById('splash-screen').style.display = 'none';
                document.getElementById('app-header').style.display = 'flex';
                document.getElementById('map-container').style.display = 'block';
                document.getElementById('control-panel').style.display = 'block';
                initMap();
                initPeer();
            }, 600);
        }

        // --- Inicializar Mapa ---
        function initMap() {
            map = L.map('map', {
                zoomControl: false,
                attributionControl: false,
            }).setView([-14.235, -51.925], 5);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 19,
            }).addTo(map);

            // Tentar pegar localiza√ß√£o atual
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        const { latitude, longitude } = pos.coords;
                        map.setView([latitude, longitude], 15);
                        state.currentPos = [latitude, longitude];
                    },
                    () => {
                        showToast('Permita acesso √† localiza√ß√£o para melhor experi√™ncia');
                    },
                    { enableHighAccuracy: true }
                );
            }
        }

        // --- Inicializar PeerJS ---
        function initPeer() {
            const id = generateCode();
            state.peer = new Peer(id, {
                debug: 0,
            });

            state.peer.on('open', (peerId) => {
                state.peerId = peerId;
                document.getElementById('my-code').textContent = peerId.toUpperCase();
            });

            state.peer.on('connection', (conn) => {
                handleIncomingConnection(conn);
            });

            state.peer.on('error', (err) => {
                console.warn('PeerJS error:', err.type);
                if (err.type === 'unavailable-id') {
                    // Tentar outro ID
                    state.peer.destroy();
                    setTimeout(initPeer, 500);
                }
            });
        }

        function generateCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = 'PDE-';
            for (let i = 0; i < 4; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code.toLowerCase();
        }

        // --- Lidar com conex√£o entrante (algu√©m quer ver minha rota) ---
        function handleIncomingConnection(conn) {
            conn.on('open', () => {
                state.connections.push(conn);
                showToast('üö¥ Um ciclista est√° acompanhando sua rota!');

                // Enviar posi√ß√µes acumuladas
                if (state.positions.length > 0) {
                    conn.send({
                        type: 'full-route',
                        positions: state.positions,
                        name: 'Ciclista ' + state.peerId.slice(-4).toUpperCase(),
                        isPedaling: state.isPedaling,
                    });
                }
            });

            conn.on('data', (data) => {
                handlePeerData(conn.peer, data);
            });

            conn.on('close', () => {
                state.connections = state.connections.filter(c => c !== conn);
                removeRider(conn.peer);
            });
        }

        // --- Conectar a outro ciclista ---
        function joinRider() {
            const input = document.getElementById('join-code-input');
            let code = input.value.trim().toLowerCase();
            if (!code) {
                showToast('Digite um c√≥digo v√°lido');
                return;
            }

            // Normalizar c√≥digo
            if (!code.startsWith('pde-')) code = 'pde-' + code;

            showLoading(true);

            const conn = state.peer.connect(code, { reliable: true });

            conn.on('open', () => {
                showLoading(false);
                state.connections.push(conn);
                showToast('üîó Conectado! Acompanhando ciclista...');
                closeShareModal();

                // Enviar nossas posi√ß√µes se estiver pedalando
                if (state.isPedaling && state.positions.length > 0) {
                    conn.send({
                        type: 'full-route',
                        positions: state.positions,
                        name: 'Ciclista ' + state.peerId.slice(-4).toUpperCase(),
                        isPedaling: state.isPedaling,
                    });
                }
            });

            conn.on('data', (data) => {
                handlePeerData(conn.peer, data);
            });

            conn.on('close', () => {
                state.connections = state.connections.filter(c => c !== conn);
                removeRider(conn.peer);
                showToast('Ciclista desconectado');
            });

            conn.on('error', () => {
                showLoading(false);
                showToast('N√£o foi poss√≠vel conectar. Verifique o c√≥digo.');
            });

            setTimeout(() => {
                if (!conn.open) {
                    showLoading(false);
                    showToast('Tempo esgotado. Verifique o c√≥digo.');
                }
            }, 10000);
        }

        // --- Processar dados do peer ---
        function handlePeerData(peerId, data) {
            if (data.type === 'position') {
                updateRiderPosition(peerId, data);
            } else if (data.type === 'full-route') {
                initRider(peerId, data);
            } else if (data.type === 'stop') {
                removeRider(peerId);
                showToast('Ciclista ' + (data.name || '') + ' parou de pedalar');
            }
        }

        function initRider(peerId, data) {
            const color = RIDER_COLORS[colorIndex++ % RIDER_COLORS.length];
            const name = data.name || 'Ciclista';

            if (state.connectedRiders[peerId]) {
                // Atualizar
                const rider = state.connectedRiders[peerId];
                const latlngs = data.positions.map(p => [p.lat, p.lng]);
                rider.polyline.setLatLngs(latlngs);
                if (latlngs.length > 0) {
                    rider.marker.setLatLng(latlngs[latlngs.length - 1]);
                }
                return;
            }

            const latlngs = data.positions.map(p => [p.lat, p.lng]);
            const polyline = L.polyline(latlngs, {
                color: color,
                weight: 4,
                opacity: 0.8,
            }).addTo(map);

            const lastPos = latlngs.length > 0 ? latlngs[latlngs.length - 1] : [-14.235, -51.925];
            const marker = L.marker(lastPos, {
                icon: L.divIcon({
                    className: 'cyclist-marker',
                    html: `<div class="marker-dot other" style="background:${color};"></div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10],
                }),
            }).addTo(map);

            state.connectedRiders[peerId] = {
                name, positions: data.positions, marker, polyline, color,
            };

            updateRidersPanel();
        }

        function updateRiderPosition(peerId, data) {
            if (!state.connectedRiders[peerId]) {
                initRider(peerId, {
                    positions: [{ lat: data.lat, lng: data.lng }],
                    name: data.name,
                });
                return;
            }

            const rider = state.connectedRiders[peerId];
            rider.positions.push({ lat: data.lat, lng: data.lng });
            rider.polyline.addLatLng([data.lat, data.lng]);
            rider.marker.setLatLng([data.lat, data.lng]);
        }

        function removeRider(peerId) {
            const rider = state.connectedRiders[peerId];
            if (rider) {
                map.removeLayer(rider.marker);
                map.removeLayer(rider.polyline);
                delete state.connectedRiders[peerId];
                updateRidersPanel();
            }
        }

        function updateRidersPanel() {
            const panel = document.getElementById('riders-panel');
            const list = document.getElementById('riders-list');
            const riderIds = Object.keys(state.connectedRiders);

            if (riderIds.length === 0) {
                panel.classList.remove('visible');
                return;
            }

            panel.classList.add('visible');
            list.innerHTML = riderIds.map(id => {
                const r = state.connectedRiders[id];
                return `<div class="rider-item">
                    <div class="rider-color" style="background:${r.color}"></div>
                    <span>${r.name}</span>
                </div>`;
            }).join('');
        }

        // --- Broadcast posi√ß√£o para todos os peers ---
        function broadcastPosition(lat, lng) {
            const data = {
                type: 'position',
                lat, lng,
                name: 'Ciclista ' + (state.peerId || '').slice(-4).toUpperCase(),
                timestamp: Date.now(),
            };
            state.connections.forEach(conn => {
                if (conn.open) conn.send(data);
            });
        }

        function broadcastStop() {
            const data = {
                type: 'stop',
                name: 'Ciclista ' + (state.peerId || '').slice(-4).toUpperCase(),
            };
            state.connections.forEach(conn => {
                if (conn.open) conn.send(data);
            });
        }

        // ============================================================
        //  MODO PEDAL
        // ============================================================
        async function togglePedal() {
            if (state.isPedaling) {
                stopPedal();
            } else {
                startPedal();
            }
        }

        async function startPedal() {
            if (!navigator.geolocation) {
                showToast('Geolocaliza√ß√£o n√£o suportada neste navegador');
                return;
            }

            showLoading(true);

            try {
                // Solicitar Wake Lock para manter tela ativa
                await requestWakeLock();
            } catch (e) {
                console.warn('Wake Lock n√£o dispon√≠vel:', e);
            }

            // Iniciar rastreamento GPS
            state.watchId = navigator.geolocation.watchPosition(
                (pos) => {
                    const { latitude, longitude, speed, accuracy } = pos.coords;

                    // Ignorar posi√ß√µes com precis√£o muito ruim
                    if (accuracy > 100) return;

                    const newPos = [latitude, longitude];

                    // Calcular dist√¢ncia
                    if (state.positions.length > 0) {
                        const lastPos = state.positions[state.positions.length - 1];
                        const dist = haversine(lastPos.lat, lastPos.lng, latitude, longitude);
                        // S√≥ adicionar se moveu mais de 3m (filtra GPS noise)
                        if (dist < 0.003) return;
                        state.totalDistance += dist;
                    }

                    state.positions.push({ lat: latitude, lng: longitude, time: Date.now() });
                    state.currentPos = newPos;

                    // Atualizar mapa
                    updateMyPosition(newPos);

                    // Atualizar stats
                    const speedKmh = speed ? (speed * 3.6) : 0;
                    document.getElementById('stat-speed').textContent = speedKmh.toFixed(1);
                    document.getElementById('stat-distance').textContent = state.totalDistance.toFixed(2);

                    // M√©dia
                    if (state.startTime) {
                        const elapsed = (Date.now() - state.startTime) / 3600000; // horas
                        const avg = elapsed > 0 ? (state.totalDistance / elapsed) : 0;
                        document.getElementById('stat-avg').textContent = avg.toFixed(1);
                    }

                    // Broadcast para peers
                    broadcastPosition(latitude, longitude);

                    showLoading(false);
                },
                (err) => {
                    showLoading(false);
                    showToast('Erro ao acessar GPS: ' + err.message);
                    console.error('Geo error:', err);
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 2000,
                    timeout: 10000,
                }
            );

            state.isPedaling = true;
            state.startTime = Date.now();
            state.totalDistance = 0;
            state.positions = [];

            // Timer
            state.timerInterval = setInterval(updateTimer, 1000);

            // UI Updates
            const btn = document.getElementById('btn-pedal');
            btn.textContent = 'PARAR PEDAL';
            btn.className = 'btn-pedal stop';
            document.getElementById('stats-bar').classList.add('visible');
            document.getElementById('status-text').textContent = 'Pedalando';
            document.getElementById('status-dot').classList.add('active');

            showToast('üö¥ Modo Pedal Ativado! Boa pedalada!');
        }

        function stopPedal() {
            // Parar GPS
            if (state.watchId !== null) {
                navigator.geolocation.clearWatch(state.watchId);
                state.watchId = null;
            }

            // Liberar Wake Lock
            releaseWakeLock();

            // Parar timer
            if (state.timerInterval) {
                clearInterval(state.timerInterval);
                state.timerInterval = null;
            }

            state.isPedaling = false;

            // Notificar peers
            broadcastStop();

            // UI Updates
            const btn = document.getElementById('btn-pedal');
            btn.textContent = 'MODO PEDAL';
            btn.className = 'btn-pedal start';
            document.getElementById('status-text').textContent = 'Finalizado';
            document.getElementById('status-dot').classList.remove('active');

            showToast('Pedalada finalizada! ' + state.totalDistance.toFixed(2) + ' km percorridos');
        }

        // --- Atualizar minha posi√ß√£o no mapa ---
        function updateMyPosition(latlng) {
            if (!myMarker) {
                myMarker = L.marker(latlng, {
                    icon: L.divIcon({
                        className: 'cyclist-marker',
                        html: '<div class="marker-dot"></div>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10],
                    }),
                }).addTo(map);

                myPolyline = L.polyline([], {
                    color: '#00e676',
                    weight: 4,
                    opacity: 0.9,
                    lineCap: 'round',
                    lineJoin: 'round',
                }).addTo(map);
            }

            myMarker.setLatLng(latlng);
            myPolyline.addLatLng(latlng);
            map.panTo(latlng, { animate: true, duration: 0.5 });
        }

        // --- Wake Lock (manter tela ativa) ---
        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    state.wakeLock = await navigator.wakeLock.request('screen');
                    state.wakeLock.addEventListener('release', () => {
                        // Tentar readquirir se ainda est√° pedalando
                        if (state.isPedaling) {
                            requestWakeLock();
                        }
                    });
                    console.log('Wake Lock ativo');
                } catch (err) {
                    console.warn('Wake Lock falhou:', err);
                }
            }
        }

        // Readquirir Wake Lock quando a p√°gina volta a ficar vis√≠vel
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && state.isPedaling) {
                requestWakeLock();
            }
        });

        function releaseWakeLock() {
            if (state.wakeLock) {
                state.wakeLock.release();
                state.wakeLock = null;
            }
        }

        // --- Timer ---
        function updateTimer() {
            if (!state.startTime) return;
            const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
            const min = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const sec = (elapsed % 60).toString().padStart(2, '0');
            const hrs = Math.floor(elapsed / 3600);
            if (hrs > 0) {
                document.getElementById('stat-time').textContent =
                    `${hrs}:${min.slice(-2)}:${sec}`;
            } else {
                document.getElementById('stat-time').textContent = `${min}:${sec}`;
            }
        }

        // --- Haversine (dist√¢ncia em km) ---
        function haversine(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // --- Centralizar mapa ---
        function centerMap() {
            if (state.currentPos) {
                map.setView(state.currentPos, 16, { animate: true });
            } else {
                showToast('Localiza√ß√£o n√£o dispon√≠vel');
            }
        }

        // --- Modal Compartilhar ---
        function openShareModal() {
            document.getElementById('share-modal').classList.add('visible');
        }

        function closeShareModal() {
            document.getElementById('share-modal').classList.remove('visible');
        }

        function copyCode() {
            const code = state.peerId || '';
            navigator.clipboard.writeText(code.toUpperCase()).then(() => {
                showToast('C√≥digo copiado!');
            }).catch(() => {
                // Fallback
                const el = document.createElement('textarea');
                el.value = code.toUpperCase();
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                showToast('C√≥digo copiado!');
            });
        }

        function nativeShare() {
            if (navigator.share) {
                navigator.share({
                    title: 'Pedalada dos Estados',
                    text: `Acompanhe minha pedalada! C√≥digo: ${(state.peerId || '').toUpperCase()}`,
                    url: window.location.href,
                }).catch(() => {});
            } else {
                copyCode();
            }
        }

        // --- Toast ---
        function showToast(msg) {
            const el = document.getElementById('toast');
            el.textContent = msg;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        // --- Loading ---
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('visible', show);
        }

        // Fechar modal ao clicar fora
        document.getElementById('share-modal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeShareModal();
        });

        // Permitir input uppercase
        document.getElementById('join-code-input').addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase();
        });

        // Enter para conectar
        document.getElementById('join-code-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') joinRider();
        });

        // --- Service Worker para funcionar em background ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => {
                // SW opcional - n√£o precisa para funcionar
            });
        }
    </script>
</body>
</html>
